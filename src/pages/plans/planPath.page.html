<ion-header>
  <ion-navbar>
    <ion-title>
      <div class="flex-space-between">
        <span>#{{plan.id}} {{plan.type}} - {{plan.status}}</span>
        <ion-icon name="more" (click)="showMenu($event)" class="pointer"></ion-icon>
        <!--<span *ngIf="plan.status == 'ACTIVE'" class="fake-link small-font" (click)="cancelPlan()">cancel</span>-->
      </div>
    </ion-title>
  </ion-navbar>
</ion-header>

<ion-content padding>
  <ion-list>
    <ion-item>
      <div class="flex-vert">
        <span *ngIf="paths.length > 0">{{paths[0].startAmount}} {{paths[0].startCurrency}} in max {{paths[0].maxSteps}} steps to {{paths[0].destCurrency}}</span>
        <div class="flex-space-between">
          <span>{{plan.runsDone}} completed runs</span>
          <span class="flex-grow"></span>
          <ion-spinner name="circles" *ngIf="pathsLoading"></ion-spinner>
        </div>
      </div>
    </ion-item>
    <ion-item *ngIf="pathsLoadingFailed">Failed to load plans</ion-item>
    <div *ngFor="let path of paths">
      <ion-item (click)="path.showSteps = !path.showSteps">
        <div class="flex-vert pointer" *ngIf="path.status != 'FINISHED'">
          <span *ngIf="path.status == 'ACTIVE'">Active since {{util.getTimeDiff(path.startDate)}}</span>
          <span *ngIf="path.status == 'PAUSED'">Paused since {{util.getTimeDiff(path.startDate)}}</span>
          <span *ngIf="path.status == 'CANCELLED'">Cancelled {{util.getTimeDiff(path.finishDate)}} ago</span>
        </div>
        <div *ngIf="path.status == 'FINISHED'">
          <div class="flex-vert pointer">
            <div class="flex-space-between">
              <span>Finished in {{util.getTimeDiff(path.startDate, path.finishDate)}}</span>
              <span>{{path.destAmount | number:'1.0-8'}} {{path.destCurrency}}</span>
            </div>
            <div class="flex-start flex-wrap" *ngIf="path.startCurrency == path.destCurrency">
              <span *ngIf="path.destAmount >= getFirstStep(path).inFilled" class="color-success margin-right-m">+{{(100 * path.destAmount / getFirstStep(path).inFilled) - 100 | number:'1.0-2'}}% {{path.destCurrency}}</span>
              <span *ngIf="path.destAmount < getFirstStep(path).inFilled" class="color-failure margin-right-m">{{(100 * path.destAmount / getFirstStep(path).inFilled) - 100 | number:'1.0-2'}}% {{path.destCurrency}}</span>
              <span *ngFor="let step of path.steps | filterDoneSteps; let i = index">
                <span *ngIf="i > 0 && (step.outAmount - path.steps[i - 1].inFilled) > 0" class="color-success margin-right-m">
                  +{{step.outAmount - path.steps[i - 1].inFilled | number:'1.0-8'}} {{step.outCurrency}}
                </span>
              </span>
            </div>
          </div>
        </div>
        <div *ngIf="path.status == 'ACTIVE' || path.status == 'PAUSED' || path.showSteps">
          <ion-item no-lines *ngFor="let step of path.steps">
            <div class="flex-vert">
              <div class="flex-space-between">
                <span *ngIf="!step.finishDate">{{step.step}}. Step started {{util.getTimeDiff(step.startDate)}} ago</span>
                <span *ngIf="step.finishDate">{{step.step}}. Step took {{util.getTimeDiff(step.startDate, step.finishDate)}}</span>
                <span>{{step.status}}</span>
              </div>
              <span class="small-font">Started on {{step.startDate | date:'HH:mm dd/MM'}}</span>
              <span class="small-font" *ngIf="step.inFilled > 0">Converted {{step.inFilled | number:'1.0-8'}} {{step.inCurrency}} into {{step.outAmount | number:'1.0-8'}} {{step.outCurrency}}</span>
              <span *ngIf="step.status == 'ACTIVE' && step.side == 'BUY'" class="small-font">
                buying {{step.orderAltcoinQty | number:'1.0-8'}} {{step.outCurrency}} for {{step.orderBasecoinQty | number:'1.0-8'}} {{step.inCurrency}} at {{step.price | number:'1.0-8'}}
              </span>
              <span *ngIf="step.status == 'ACTIVE' && step.side == 'SELL'" class="small-font">
                selling {{step.orderAltcoinQty | number:'1.0-8'}} {{step.inCurrency}} to {{step.orderBasecoinQty | number:'1.0-8'}} {{step.outCurrency}} at {{step.price | number:'1.0-8'}}
              </span>
            </div>
          </ion-item>
        </div>
      </ion-item>
    </div>
  </ion-list>
</ion-content>
